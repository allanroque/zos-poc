---
- name: Automate SNOW - Incident Create
  hosts: localhost
  connection: local
  vars:
    sn_short_description: "{{ ansible_eda.event.alert.annotations.summary }}"
    sn_description: "{{ ansible_eda.event.alert.annotations.description }} - Incident generated by ANSIBLE EDA for {{ ansible_eda.event.alert.labels.instance }} !"
    sn_impact: "{{ 'high' if ansible_eda.event.alert.labels.severity == 'critical' else 'medium' if ansible_eda.event.alert.labels.severity == 'warning' else 'low' }}"
    sn_urgency: "{{ 'high' if ansible_eda.event.alert.labels.severity == 'critical' else 'medium' if ansible_eda.event.alert.labels.severity == 'warning' else 'low' }}"
###  vars_files:
###  - vars/main.yml
  collections:
    - servicenow.itsm

  tasks:
    - name: Create incident
      servicenow.itsm.incident:
        state: new
        instance:
          host: "{{ snow_instance }}"
          username: "{{ snow_username }}"
          password: "{{ snow_password }}"
        caller: "{{ lookup('env', 'SN_USERNAME') }}"
        short_description: "{{ sn_short_description }}"
        description: "{{ sn_description }}"
        impact: "{{ sn_impact }}"
        urgency: "{{ sn_urgency }}"
      register: new_incident

    - set_fact:
        sn_incident_number: "{{ new_incident.record.number }}"

    - debug:
        var: new_incident.record.number

    - name: Set incident number
      set_stats:
        data:
          sn_incident_number: "{{ new_incident.record.number }}"